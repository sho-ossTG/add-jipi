---
phase: 01-contract-compatibility-baseline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - addon.js
  - tests/contract-manifest-catalog.test.js
  - package.json
autonomous: true
requirements:
  - CONT-01
  - CONT-02
must_haves:
  truths:
    - User can install the addon from a valid manifest response.
    - User can browse the configured catalog and receive protocol-valid metas.
    - Unsupported catalog requests return a contract-valid empty payload.
  artifacts:
    - path: addon.js
      provides: Manifest and catalog contract output.
      contains: "manifest"
    - path: tests/contract-manifest-catalog.test.js
      provides: Automated manifest and catalog contract assertions.
      contains: "manifest.json"
    - path: package.json
      provides: Runnable contract test command.
      contains: "scripts"
  key_links:
    - from: serverless.js
      to: addon.js
      via: "getRouter(addonInterface)"
      pattern: "getRouter\\(addonInterface\\)"
    - from: addon.js
      to: manifest catalogs entry
      via: "addonBuilder(manifest)"
      pattern: "catalogs:"
---

<objective>
Lock manifest and catalog behavior to protocol-valid baseline output while preserving existing Phase 1 behavior constraints from `serverless.js`.

Purpose: Ensure install and catalog browsing compatibility is deterministic before stream-path changes.
Output: Baseline-safe manifest/catalog fixes plus executable contract checks.
</objective>

<execution_context>
@C:/Users/enggy/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/enggy/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-contract-compatibility-baseline/01-CONTEXT.md
@.planning/phases/01-contract-compatibility-baseline/01-RESEARCH.md
@addon.js
@serverless.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply minimal manifest and catalog schema hardening</name>
  <files>addon.js</files>
  <action>Update manifest/catalog metadata only where contract checks require it (for example, ensure `catalogs[].name` exists if missing), while preserving current baseline behavior and resource scope. Keep `serverless.js` behavior unchanged, do not alter fallback policy, and do not introduce retry/timeout tuning in this phase.</action>
  <verify>Run `node -e "const addon=require('./addon'); const m=addon.manifest; if(!m||m.id!=='org.jipi.onepiece'||!Array.isArray(m.catalogs)||!m.catalogs[0]||!m.catalogs[0].name) throw new Error('manifest contract mismatch'); console.log('manifest-ok');"`</verify>
  <done>Manifest remains install-compatible and catalog declarations are protocol-valid without changing baseline route policy.</done>
</task>

<task type="auto">
  <name>Task 2: Add automated manifest and catalog contract checks</name>
  <files>tests/contract-manifest-catalog.test.js, package.json</files>
  <action>Create a Node built-in test file that invokes the serverless handler through HTTP requests and validates: `GET /manifest.json` returns JSON with required contract fields, `GET /catalog/series/onepiece_catalog.json` returns `{ metas: [...] }` with valid `id/type/name`, and unsupported catalog requests return `{ metas: [] }`. Add an npm script to run this contract test. Keep assertions focused on compatibility boundaries, not internal implementation details.</action>
  <verify>Run `npm run test:contract:manifest-catalog` and confirm all tests pass.</verify>
  <done>Contract checks fail on malformed manifest/catalog output and pass on current baseline-compatible behavior.</done>
</task>

</tasks>

<verification>
Execute `npm run test:contract:manifest-catalog` and confirm no failing assertions for manifest install shape and catalog payload contract.</verification>

<success_criteria>
1. `manifest.json` is protocol-valid for Stremio install flow.
2. Catalog route returns valid metas payload for supported catalog id.
3. Unsupported catalog id/path returns contract-valid empty metas payload.
</success_criteria>

<output>
After completion, create `.planning/phases/01-contract-compatibility-baseline/01-01-SUMMARY.md`
</output>
