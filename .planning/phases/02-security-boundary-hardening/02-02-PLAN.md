---
phase: 02-security-boundary-hardening
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - serverless.js
  - tests/contract-cors-policy.test.js
  - package.json
autonomous: true
requirements:
  - SECU-04
must_haves:
  truths:
    - "Browser-origin requests receive CORS access only when origin is explicitly allowlisted."
    - "Preflight OPTIONS requests return explicit allowed methods and headers."
    - "Disallowed origins do not receive permissive CORS headers."
  artifacts:
    - path: serverless.js
      provides: "Route-aware CORS policy and OPTIONS preflight handling with explicit allowlists"
    - path: tests/contract-cors-policy.test.js
      provides: "Regression tests for allowed and disallowed origin/header behavior"
    - path: package.json
      provides: "Dedicated CORS contract test script"
  key_links:
    - from: serverless.js
      to: "all JSON response helpers"
      via: "shared CORS header application"
      pattern: "applyCors|Access-Control-Allow-Origin"
    - from: serverless.js
      to: "OPTIONS requests"
      via: "preflight responder"
      pattern: "method === \"OPTIONS\"|Access-Control-Allow-Methods"
---

<objective>
Enforce explicit CORS policy for browser-origin traffic with deterministic preflight handling.

Purpose: Close remaining Phase 2 security requirement by constraining cross-origin access at the boundary.
Output: Route-aware CORS enforcement and automated CORS contract tests.
</objective>

<execution_context>
@C:/Users/enggy/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/enggy/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-security-boundary-hardening/02-RESEARCH.md
@.planning/phases/02-security-boundary-hardening/02-01-SUMMARY.md
@serverless.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement explicit allowlist CORS matrix and preflight handling</name>
  <files>serverless.js</files>
  <action>Add centralized CORS helpers that parse explicit env-configured allowlists (origins and request headers), set `Vary: Origin` when reflecting an allowed origin, and return explicit `Access-Control-Allow-Methods`/`Access-Control-Allow-Headers` for `OPTIONS` requests. Keep Stremio route compatibility by applying policy at HTTP boundary without changing addon payload contracts; do not use wildcard allow-headers.</action>
  <verify>Run `node --test tests/contract-cors-policy.test.js` and confirm allowed origins pass preflight while disallowed origins receive no allow-origin grant.</verify>
  <done>Browser CORS behavior is explicit, deterministic, and allowlist-driven for both normal and preflight requests.</done>
</task>

<task type="auto">
  <name>Task 2: Add CORS contract tests and script wiring</name>
  <files>tests/contract-cors-policy.test.js, package.json</files>
  <action>Create `tests/contract-cors-policy.test.js` using existing serverless boundary test pattern with request/response doubles. Cover at minimum: (1) allowed origin + allowed header preflight success with explicit headers, (2) disallowed origin preflight denied/no grant, (3) regular allowed-origin GET response includes expected CORS headers, and (4) regular request without Origin remains protocol-safe for non-browser clients.</action>
  <verify>Run `npm run test:contract:cors && npm run test:contract:security && npm run test:contract:stream && npm run test:contract:manifest-catalog`.</verify>
  <done>CORS behavior is locked by executable contract tests and full contract suite remains green.</done>
</task>

</tasks>

<verification>
Run `npm run test:contract:cors && npm run test:contract:security && npm run test:contract:stream && npm run test:contract:manifest-catalog`.
</verification>

<success_criteria>
1. Only explicitly allowed origins and headers receive CORS grants.
2. Browser preflight is handled explicitly with allowed methods/headers.
3. Disallowed origins do not obtain cross-origin access headers.
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-boundary-hardening/02-02-SUMMARY.md`
</output>
