---
phase: 02-security-boundary-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - serverless.js
  - tests/contract-security-boundary.test.js
  - package.json
  - package-lock.json
autonomous: true
requirements:
  - SECU-01
  - SECU-02
  - SECU-03
must_haves:
  truths:
    - "Unauthorized requests to diagnostics/admin routes are denied."
    - "Authorized operators can access diagnostics/admin routes."
    - "Client attribution uses trusted identity and cannot be spoofed by arbitrary forwarded headers."
    - "Public responses never expose raw IP values or internal error detail strings."
  artifacts:
    - path: serverless.js
      provides: "Central security boundary helpers for route classification, operator authorization, trusted attribution, and response shaping"
    - path: tests/contract-security-boundary.test.js
      provides: "Regression coverage for operator auth gates, trusted attribution behavior, and redacted diagnostics/public errors"
    - path: package.json
      provides: "Executable security contract test script"
    - path: package-lock.json
      provides: "Pinned dependency tree including proxy-addr"
  key_links:
    - from: serverless.js
      to: "operator diagnostics routes"
      via: "route classification -> authorizeOperator gate"
      pattern: "classifyRoute.*operator|authorizeOperator"
    - from: serverless.js
      to: "request controls and stream handling"
      via: "trusted client IP helper"
      pattern: "getTrustedClientIp|proxy-addr"
    - from: serverless.js
      to: "public JSON responses"
      via: "centralized sanitized error response helper"
      pattern: "sendPublicError|sanitize|redact"
---

<objective>
Harden the HTTP boundary so diagnostics and admin surfaces are operator-only, request attribution is trust-based, and public responses are sanitized.

Purpose: Meet core security requirements before reliability/observability phases build on these surfaces.
Output: Security primitives and regression tests for authz, attribution, and redaction behavior.
</objective>

<execution_context>
@C:/Users/enggy/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/enggy/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-security-boundary-hardening/02-RESEARCH.md
@serverless.js
@tests/contract-stream.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add centralized operator auth and trusted attribution primitives</name>
  <files>serverless.js</files>
  <action>Implement boundary helpers in `serverless.js` to classify routes (`public`, `stremio`, `operator`), authorize operator routes with a static secret from env (`OPERATOR_TOKEN`) using `node:crypto` `timingSafeEqual`, and derive client IP with `proxy-addr` trust policy (not raw `x-forwarded-for` splitting). Keep addon protocol router behavior unchanged; add these checks before `/health` diagnostics detail access, `/quarantine`, and any future operator route handling.</action>
  <verify>Run `node --test tests/contract-security-boundary.test.js` and confirm unauthorized operator-route requests return 401/403 while authorized requests proceed.</verify>
  <done>Operator surfaces are deny-by-default, auth checks are constant-time, and request attribution logic no longer trusts attacker-controlled forwarded header parsing.</done>
</task>

<task type="auto">
  <name>Task 2: Redact diagnostics payloads and sanitize public error bodies</name>
  <files>serverless.js</files>
  <action>Refactor diagnostics/public responses to use centralized redaction and error-shaping helpers. Ensure `/quarantine` output never includes raw IPs or raw upstream error messages; redact/normalize sensitive fields before rendering. For public non-operator failures, return generic error bodies (no internal `err.message` leakage) while preserving protocol-safe stream fallbacks. Split health behavior so public liveness remains minimal and operator-only detail remains gated.</action>
  <verify>Run `node --test tests/contract-security-boundary.test.js` and assert diagnostics/public response snapshots contain redacted values and generic external error strings only.</verify>
  <done>Public routes never expose sensitive diagnostics data, and operator-only diagnostics still provide actionable data after auth.</done>
</task>

<task type="auto">
  <name>Task 3: Add security boundary contract tests and wiring scripts</name>
  <files>tests/contract-security-boundary.test.js, package.json, package-lock.json</files>
  <action>Create `tests/contract-security-boundary.test.js` using existing handler-level Node test style to cover: unauthorized diagnostics denial, authorized diagnostics allow, spoofed forwarded header resistance through trusted attribution path, and redacted diagnostics/public error output. Add `test:contract:security` script in `package.json`. Install `proxy-addr@2.0.7` per research and commit lockfile updates.</action>
  <verify>Run `npm run test:contract:security && npm run test:contract:stream && npm run test:contract:manifest-catalog`.</verify>
  <done>Security boundary behavior is regression-tested at the HTTP handler layer and all contract suites pass together.</done>
</task>

</tasks>

<verification>
Run full contract baseline after implementation: `npm run test:contract:security && npm run test:contract:stream && npm run test:contract:manifest-catalog`.
</verification>

<success_criteria>
1. Unauthenticated/unauthorized requests cannot access operator diagnostics/admin responses.
2. Authorized operator requests can access diagnostics routes successfully.
3. Attribution and diagnostics/public outputs are spoof-resistant and sanitized.
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-boundary-hardening/02-01-SUMMARY.md`
</output>
