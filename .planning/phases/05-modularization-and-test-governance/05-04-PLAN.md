---
phase: 05-modularization-and-test-governance
plan: 04
type: execute
wave: 4
depends_on: ["05-03"]
files_modified:
  - modules/integrations/broker-client.js
  - modules/routing/stream-route.js
  - modules/presentation/stream-payloads.js
  - serverless.js
  - addon.js
autonomous: true
must_haves:
  truths:
    - "Maintainer can change broker integration logic without touching presentation payload shaping."
    - "Maintainer can change stream-route orchestration without editing entrypoint transport boilerplate."
    - "Stream route behavior remains contract-compatible after modular stream/presentation rewiring."
  artifacts:
    - path: "modules/routing/stream-route.js"
      provides: "Stream route orchestration and latest-selection handling"
      exports: ["handleStreamRequest"]
    - path: "modules/presentation/stream-payloads.js"
      provides: "Protocol-safe stream, degraded, and fallback payload shaping"
      exports: ["formatStream", "buildDegradedStreamPayload", "sendDegradedStream"]
    - path: "serverless.js"
      provides: "Thin stream composition over modular route handlers"
      contains: "require(\"./modules/routing/stream-route\")"
  key_links:
    - from: "modules/routing/stream-route.js"
      to: "modules/integrations/broker-client.js"
      via: "broker resolution boundary"
      pattern: "require\(\"\.\./integrations/broker-client\"\)"
    - from: "modules/routing/stream-route.js"
      to: "modules/presentation/stream-payloads.js"
      via: "degraded/success payload shaping"
      pattern: "require\(\"\.\./presentation/stream-payloads\"\)"
---

<objective>
Migrate stream orchestration and payload presentation to modular routing/presentation/integration boundaries while preserving wire-level behavior.

Purpose: Complete the second high-risk rewiring slice separately from request-controls to reduce context and regression risk.
Output: Stream route and payload logic are module-owned, with entrypoint limited to composition.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-modularization-and-test-governance/05-CONTEXT.md
@.planning/phases/05-modularization-and-test-governance/05-03-SUMMARY.md
@serverless.js
@addon.js
@tests/contract-stream.test.js
@tests/contract-stream-reliability.test.js
@tests/contract-observability.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire stream route orchestration and payload shaping modules</name>
  <files>modules/integrations/broker-client.js, modules/routing/stream-route.js, modules/presentation/stream-payloads.js, serverless.js, addon.js</files>
  <action>Move stream-specific orchestration (episode parsing, in-flight dedupe, latest selection handling, resolve path, and degraded mapping) into `modules/routing/stream-route.js` with presentation delegated to `modules/presentation/stream-payloads.js`. Keep broker-specific outbound logic in `modules/integrations/broker-client.js` and ensure policy code does not import it directly. Keep Stremio response shape exactly compatible with existing contract tests.</action>
  <verify>`npm run test:contract:stream && npm run test:contract:reliability && npm run test:contract:observability` passes.</verify>
  <done>Stream route business logic resides in modular routing/presentation/integration files, and runtime contract behavior remains stable.</done>
</task>

<task type="auto">
  <name>Task 2: Remove reusable stream business logic from serverless entrypoint</name>
  <files>serverless.js</files>
  <action>Delete or inline-pass-through any remaining reusable stream business logic from `serverless.js` that now belongs in modules. Retain only top-level transport concerns (request setup, route branching, response finalization, and telemetry lifecycle hooks). Do not change endpoint surface or status-code behavior.</action>
  <verify>`node --check serverless.js` succeeds and `npm run test:contract:stream` still passes.</verify>
  <done>`serverless.js` no longer hosts reusable stream-domain logic and acts as a thin composition layer.</done>
</task>

</tasks>

<verification>
Run stream and observability contract suites to prove modular rewiring preserved protocol output, degraded mapping, and telemetry behavior.
</verification>

<success_criteria>
Stream route orchestration, presentation, and integration concerns are separated by module boundaries with entrypoint code reduced to composition.
</success_criteria>

<output>
After completion, create `.planning/phases/05-modularization-and-test-governance/05-04-SUMMARY.md`
</output>
