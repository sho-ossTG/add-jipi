---
phase: 05-modularization-and-test-governance
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - modules/policy/time-window.js
  - modules/policy/session-gate.js
  - modules/policy/operator-auth.js
  - modules/integrations/redis-client.js
  - modules/routing/request-controls.js
  - serverless.js
autonomous: true
must_haves:
  truths:
    - "Maintainer can change stream admission policy logic without editing route orchestration internals."
    - "Request-control decisions execute through modular boundaries with existing reason codes preserved."
    - "Entrypoint keeps request-control wiring thin instead of embedding reusable policy logic."
  artifacts:
    - path: "modules/routing/request-controls.js"
      provides: "Composed policy admission decision flow"
      exports: ["applyRequestControls"]
    - path: "modules/policy/session-gate.js"
      provides: "Deterministic session-gating decision primitives"
      exports: ["runAtomicSessionGate"]
    - path: "serverless.js"
      provides: "Thin request-control composition over modules"
      contains: "require(\"./modules/routing/request-controls\")"
  key_links:
    - from: "serverless.js"
      to: "modules/routing/request-controls.js"
      via: "policy composition import"
      pattern: "require\(\"\./modules/routing/request-controls\"\)"
    - from: "modules/routing/request-controls.js"
      to: "modules/integrations/redis-client.js"
      via: "integration injection boundary"
      pattern: "require\(\"\.\./integrations/redis-client\"\)"
---

<objective>
Migrate stream request-controls rewiring into modular policy/integration boundaries as a focused high-risk slice.

Purpose: Reduce rewiring risk by isolating admission and policy composition from stream presentation/orchestration changes.
Output: `serverless.js` delegates request-control decisions to modular policy/integration routing composition.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-modularization-and-test-governance/05-CONTEXT.md
@.planning/phases/05-modularization-and-test-governance/05-02-SUMMARY.md
@serverless.js
@tests/contract-stream.test.js
@tests/contract-stream-reliability.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire policy and Redis integration modules into request control flow</name>
  <files>modules/policy/time-window.js, modules/policy/session-gate.js, modules/policy/operator-auth.js, modules/integrations/redis-client.js, modules/routing/request-controls.js, serverless.js</files>
  <action>Replace inline request-control helpers in `serverless.js` with imports from `modules/policy/*`, `modules/integrations/redis-client.js`, and `modules/routing/request-controls.js`. Preserve policy outcomes and reason codes (`blocked:shutdown_window`, `blocked:slot_taken`, `admitted:*`) and keep telemetry semantics unchanged. Ensure policy modules remain policy-only and do not call external services except via injected integration functions.</action>
  <verify>`npm run test:contract:stream && npm run test:contract:reliability` passes.</verify>
  <done>Request controls execute through modular policy/integration boundaries with no stream contract drift.</done>
</task>

<task type="auto">
  <name>Task 2: Remove remaining reusable request-control business logic from serverless entrypoint</name>
  <files>serverless.js</files>
  <action>Delete or pass-through any remaining reusable request-control business logic from `serverless.js` that now belongs to modular files. Keep only transport lifecycle orchestration in entrypoint code and preserve endpoint behavior/status semantics.</action>
  <verify>`node --check serverless.js` succeeds and `npm run test:contract:stream` still passes.</verify>
  <done>`serverless.js` no longer contains reusable request-control domain logic and acts as thin composition for this concern.</done>
</task>

</tasks>

<verification>
Run stream and reliability contract suites to prove request-control modular rewiring preserved admission behavior and protocol output.
</verification>

<success_criteria>
Request-control behavior is modularized by concern, making policy/integration updates independent from stream orchestration and presentation changes.
</success_criteria>

<output>
After completion, create `.planning/phases/05-modularization-and-test-governance/05-03-SUMMARY.md`
</output>
