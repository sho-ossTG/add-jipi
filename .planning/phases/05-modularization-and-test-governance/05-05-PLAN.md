---
phase: 05-modularization-and-test-governance
plan: 05
type: execute
wave: 5
depends_on: ["05-04"]
files_modified:
  - modules/routing/operator-routes.js
  - modules/routing/http-handler.js
  - modules/presentation/quarantine-page.js
  - modules/presentation/public-pages.js
  - modules/presentation/operator-diagnostics.js
  - serverless.js
  - modules/BOUNDARIES.md
autonomous: true
must_haves:
  truths:
    - "Maintainer can modify operator/public route behavior without editing stream-domain modules."
    - "Maintainer can modify HTML/JSON presentation output without changing integration clients."
    - "Runtime entrypoint is a thin composer that delegates to modular handlers."
  artifacts:
    - path: "modules/routing/http-handler.js"
      provides: "Primary request handler composition for route dispatch"
      exports: ["createHttpHandler"]
    - path: "modules/routing/operator-routes.js"
      provides: "Operator route branching and auth-gated diagnostics handling"
      exports: ["handleOperatorRoute"]
    - path: "modules/presentation/quarantine-page.js"
      provides: "Quarantine HTML rendering and sanitization presentation boundary"
      exports: ["renderQuarantinePage"]
    - path: "serverless.js"
      provides: "Thin adapter exporting composed handler"
      contains: "module.exports = createHttpHandler"
  key_links:
    - from: "serverless.js"
      to: "modules/routing/http-handler.js"
      via: "entrypoint composition import"
      pattern: "require\(\"\./modules/routing/http-handler\"\)"
    - from: "modules/routing/operator-routes.js"
      to: "modules/presentation/operator-diagnostics.js"
      via: "diagnostics response projection"
      pattern: "require\(\"\.\./presentation/operator-diagnostics\"\)"
    - from: "modules/routing/operator-routes.js"
      to: "modules/presentation/quarantine-page.js"
      via: "quarantine page rendering"
      pattern: "require\(\"\.\./presentation/quarantine-page\"\)"
---

<objective>
Finish Phase 5 modularization by migrating operator/public routing and presentation concerns, leaving `serverless.js` as a thin adapter only.

Purpose: Complete MAINT-01 boundary separation across all core backend concerns after stream-path rewiring is stabilized.
Output: Modular route composer and presentation modules for operator/public surfaces with documented import-direction alignment.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-modularization-and-test-governance/05-CONTEXT.md
@.planning/phases/05-modularization-and-test-governance/05-04-SUMMARY.md
@serverless.js
@observability/diagnostics.js
@tests/contract-security-boundary.test.js
@tests/contract-observability.test.js
@tests/contract-cors-policy.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract operator and public route orchestration into routing modules</name>
  <files>modules/routing/operator-routes.js, modules/routing/http-handler.js, serverless.js</files>
  <action>Move operator/public route branching (`/`, `/health`, `/health/details`, `/operator/metrics`, `/quarantine`, CORS preflight, auth gate) into modular routing handlers. Keep route-level orchestration in routing modules and ensure reusable decision logic stays in policy modules. Update `serverless.js` to export the composed handler from `modules/routing/http-handler.js` with no embedded reusable business logic.</action>
  <verify>`npm run test:contract:security && npm run test:contract:cors` passes.</verify>
  <done>Operator/public route orchestration is modular and `serverless.js` is reduced to a thin adapter.</done>
</task>

<task type="auto">
  <name>Task 2: Extract presentation concerns for quarantine and diagnostics outputs</name>
  <files>modules/presentation/quarantine-page.js, modules/presentation/public-pages.js, modules/presentation/operator-diagnostics.js, modules/routing/operator-routes.js</files>
  <action>Move HTML rendering and response-shaping logic into presentation modules: quarantine HTML rendering, landing/public page rendering, and operator diagnostics payload shaping integration points. Reuse existing observability projector helpers where applicable and avoid importing presentation modules from integrations. Preserve sanitized payload guarantees and existing endpoint responses.</action>
  <verify>`npm run test:contract:observability && npm run test:contract:security` passes.</verify>
  <done>Presentation code is isolated in dedicated modules, and diagnostics/quarantine surfaces keep current contract and sanitization behavior.</done>
</task>

<task type="auto">
  <name>Task 3: Finalize boundary documentation with post-migration file-level examples</name>
  <files>modules/BOUNDARIES.md</files>
  <action>Update `modules/BOUNDARIES.md` with final file-level examples after migration (which module imports which) and explicitly note that import-direction enforcement automation is deferred to a future phase.</action>
  <verify>`modules/BOUNDARIES.md` references actual migrated files and still includes documented-now/enforce-later guidance.</verify>
  <done>Maintainers have finalized import-direction guidance matching implemented modular structure.</done>
</task>

</tasks>

<verification>
Run security, CORS, and observability contract suites to verify operator/public modularization preserved auth boundaries, diagnostics shape, and sanitization.
</verification>

<success_criteria>
Routing, policy, integrations, and presentation concerns are separated across module boundaries with `serverless.js` acting only as runtime composition glue.
</success_criteria>

<output>
After completion, create `.planning/phases/05-modularization-and-test-governance/05-05-SUMMARY.md`
</output>
