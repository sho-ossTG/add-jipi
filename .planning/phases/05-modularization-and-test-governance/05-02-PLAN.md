---
phase: 05-modularization-and-test-governance
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - modules/presentation/stream-payloads.js
  - modules/routing/request-controls.js
  - modules/routing/stream-route.js
  - modules/routing/operator-routes.js
  - modules/index.js
autonomous: true
must_haves:
  truths:
    - "Maintainer can identify route composition and response-shaping ownership without rewiring runtime yet."
    - "Maintainer can see stream and operator routing surfaces prepared as module entry points before migration."
    - "Scaffold step remains isolated from behavior-risk rewiring in serverless.js."
  artifacts:
    - path: "modules/presentation/stream-payloads.js"
      provides: "Protocol-safe stream and degraded payload shaping boundary"
      exports: ["formatStream", "buildDegradedStreamPayload", "sendDegradedStream"]
    - path: "modules/routing/request-controls.js"
      provides: "Route policy composition entry"
      exports: ["applyRequestControls"]
    - path: "modules/routing/stream-route.js"
      provides: "Stream-route orchestration entry"
      exports: ["handleStreamRequest"]
    - path: "modules/index.js"
      provides: "Module root export map for maintainers"
      contains: "module.exports"
  key_links:
    - from: "modules/routing/request-controls.js"
      to: "modules/policy/time-window.js"
      via: "injected policy dependency boundary"
      pattern: "(deps|injected).*(timeWindow|time-window)"
    - from: "modules/routing/stream-route.js"
      to: "modules/presentation/stream-payloads.js"
      via: "injected presentation dependency boundary"
      pattern: "(deps|injected).*(formatStream|sendDegradedStream|streamPayloads)"
---

<objective>
Complete scaffold step by adding routing and presentation module roots plus a module export map, without runtime rewiring.

Purpose: Preserve the locked two-step migration strategy by preparing concern-specific modules first and deferring riskier behavior changes.
Output: Routing/presentation scaffold modules and `modules/index.js` ready for controlled rewiring plans.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-modularization-and-test-governance/05-CONTEXT.md
@.planning/phases/05-modularization-and-test-governance/05-01-SUMMARY.md
@serverless.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold routing and presentation composition modules</name>
  <files>modules/presentation/stream-payloads.js, modules/routing/request-controls.js, modules/routing/stream-route.js, modules/routing/operator-routes.js</files>
  <action>Create routing and presentation module shells that accept injected dependencies and expose named handlers used later by the serverless entrypoint. `stream-payloads.js` owns stream/degraded payload shaping, `request-controls.js` composes policy decisions, `stream-route.js` owns stream orchestration entry, and `operator-routes.js` owns operator endpoint branching entry. Keep `serverless.js` behavior unchanged in this plan.</action>
  <verify>`node --check modules/presentation/stream-payloads.js modules/routing/request-controls.js modules/routing/stream-route.js modules/routing/operator-routes.js` succeeds.</verify>
  <done>Routing and presentation scaffolds exist with explicit module APIs and no runtime regression risk from premature rewiring.</done>
</task>

<task type="auto">
  <name>Task 2: Publish module root export map for maintainability</name>
  <files>modules/index.js</files>
  <action>Create `modules/index.js` as a thin export map for module roots and concern entry points created in plans 05-01 and 05-02. Keep this file declarative only (exports and ownership map), with no business logic.</action>
  <verify>`node --check modules/index.js` succeeds.</verify>
  <done>Maintainers have a single canonical export map for the modular scaffold before rewiring starts.</done>
</task>

</tasks>

<verification>
Confirm all routing/presentation scaffolds and `modules/index.js` exist and syntax-check cleanly, with no runtime rewiring applied yet.
</verification>

<success_criteria>
All module roots needed for migration are scaffolded and discoverable, enabling controlled rewiring with smaller risk per plan.
</success_criteria>

<output>
After completion, create `.planning/phases/05-modularization-and-test-governance/05-02-SUMMARY.md`
</output>
