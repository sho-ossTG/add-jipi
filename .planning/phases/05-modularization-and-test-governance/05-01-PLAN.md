---
phase: 05-modularization-and-test-governance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - modules/BOUNDARIES.md
  - modules/policy/time-window.js
  - modules/policy/session-gate.js
  - modules/policy/operator-auth.js
  - modules/integrations/redis-client.js
  - modules/integrations/broker-client.js
autonomous: true
must_haves:
  truths:
    - "Maintainer can identify policy vs integration ownership without reading serverless.js internals."
    - "Maintainer can see documented import-direction and no-mix constraints in-repo before rewiring begins."
    - "Phase 5 migration starts from concern-owned policy/integration scaffolds instead of ad-hoc extraction."
  artifacts:
    - path: "modules/BOUNDARIES.md"
      provides: "Boundary map, no-mix rules, and allowed import directions"
      contains: "integrations must not import presentation"
    - path: "modules/policy/time-window.js"
      provides: "Time-window policy primitives"
      exports: ["getJerusalemInfo", "isWithinShutdownWindow"]
    - path: "modules/policy/session-gate.js"
      provides: "Atomic session gate primitives"
      exports: ["runAtomicSessionGate"]
    - path: "modules/integrations/redis-client.js"
      provides: "Redis command/eval integration boundary"
      exports: ["createRedisClient"]
  key_links:
    - from: "modules/BOUNDARIES.md"
      to: "modules/policy/time-window.js"
      via: "documented ownership example"
      pattern: "policy"
    - from: "modules/BOUNDARIES.md"
      to: "modules/integrations/redis-client.js"
      via: "documented no-mix and import direction"
      pattern: "integrations"
---

<objective>
Create the first-step scaffold for boundary policy and service integrations so high-risk rewiring starts from explicit concern ownership.

Purpose: Preserve the two-step migration decision by separating scaffold creation from runtime rewiring.
Output: Boundary rules plus policy/integration module entry files ready for later wiring.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-modularization-and-test-governance/05-CONTEXT.md
@.planning/phases/04-observability-and-diagnostics/04-03-SUMMARY.md
@serverless.js
@addon.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document boundary map and import-direction rules in modules root</name>
  <files>modules/BOUNDARIES.md</files>
  <action>Create `modules/BOUNDARIES.md` defining the hybrid boundary model, module responsibilities (`routing`, `policy`, `integrations`, `presentation`), and hard no-mix constraints from phase context. Include explicit allowed import directions and forbidden imports. Keep this as documentation-only guardrails (do not add lint enforcement yet, per locked decisions).</action>
  <verify>File exists and contains sections `Module boundaries`, `Allowed imports`, and `Forbidden imports` with all three hard no-mix constraints.</verify>
  <done>`modules/BOUNDARIES.md` provides maintainer-readable modular ownership and import-direction rules used by subsequent migration tasks.</done>
</task>

<task type="auto">
  <name>Task 2: Scaffold policy and integration module entry points</name>
  <files>modules/policy/time-window.js, modules/policy/session-gate.js, modules/policy/operator-auth.js, modules/integrations/redis-client.js, modules/integrations/broker-client.js</files>
  <action>Create module files that mirror existing behavior boundaries without changing runtime wiring yet: move/duplicate pure policy helpers into policy files and integration helpers into integration files with stable exports. `time-window.js` must expose deterministic time helpers (including a clock-injection-friendly API), `session-gate.js` must expose atomic gate execution primitives, `operator-auth.js` must isolate token auth decisions, and integration files must wrap broker/redis calls only. Do not introduce presentation logic into these files.</action>
  <verify>`node --check modules/policy/time-window.js modules/policy/session-gate.js modules/policy/operator-auth.js modules/integrations/redis-client.js modules/integrations/broker-client.js` succeeds.</verify>
  <done>Policy and integration concerns are scaffolded in dedicated files with import boundaries matching `modules/BOUNDARIES.md`.</done>
</task>

</tasks>

<verification>
Confirm boundary docs and policy/integration scaffold files exist and syntax-check cleanly; verify runtime entry files (`serverless.js`, `addon.js`) remain unchanged in this scaffold-only plan.
</verification>

<success_criteria>
Policy/integration concerns and boundary rules are scaffolded with clear ownership, enabling low-risk rewiring in subsequent plans.
</success_criteria>

<output>
After completion, create `.planning/phases/05-modularization-and-test-governance/05-01-SUMMARY.md`
</output>
