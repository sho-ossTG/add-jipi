---
phase: 05-modularization-and-test-governance
plan: 06
type: execute
wave: 6
depends_on: ["05-05"]
files_modified:
  - modules/policy/time-window.js
  - modules/policy/session-gate.js
  - tests/helpers/runtime-fixtures.js
  - tests/policy-time-window.test.js
  - tests/policy-session-gate.test.js
  - tests/contract-stream-failures.test.js
  - tests/contract-stream.test.js
  - tests/contract-stream-reliability.test.js
  - package.json
  - TEST-GATES.md
autonomous: true
must_haves:
  truths:
    - "Maintainer can run one deterministic test command before deployment and catch stream contract/failure regressions."
    - "Maintainer can reproduce policy time-window behavior at boundary hours using deterministic tests."
    - "Maintainer can reproduce session-gating admission/rotation/blocking behavior deterministically from automated tests."
  artifacts:
    - path: "tests/policy-time-window.test.js"
      provides: "Deterministic policy tests for shutdown window boundaries"
      contains: "00:00, 00:59, 01:00, 07:59, 08:00"
    - path: "tests/policy-session-gate.test.js"
      provides: "Deterministic session-gate tests for admit/rotate/block behavior"
      contains: "admitted:new, admitted:rotated, blocked:slot_taken"
    - path: "tests/contract-stream-failures.test.js"
      provides: "Failure-branch contract coverage for dependency and validation paths"
      contains: "dependency_timeout"
    - path: "package.json"
      provides: "Required deployment gate scripts"
      contains: "test:gate:required"
  key_links:
    - from: "package.json"
      to: "tests/contract-stream.test.js"
      via: "required gate script"
      pattern: "test:contract:stream"
    - from: "package.json"
      to: "tests/policy-time-window.test.js"
      via: "required gate script"
      pattern: "policy-time-window"
    - from: "tests/policy-session-gate.test.js"
      to: "modules/policy/session-gate.js"
      via: "deterministic policy module test target"
      pattern: "require\(\"\.\./modules/policy/session-gate\"\)"
---

<objective>
Implement Phase 5 test governance so maintainers can run deterministic policy and contract/failure validation before deployment.

Purpose: Deliver MAINT-02 and MAINT-03 with an explicit required gate command and deterministic policy coverage.
Output: New deterministic policy tests, failure-branch contract coverage, and a documented test gate matrix.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-modularization-and-test-governance/05-CONTEXT.md
@.planning/phases/05-modularization-and-test-governance/05-05-SUMMARY.md
@tests/contract-stream.test.js
@tests/contract-stream-reliability.test.js
@tests/contract-observability.test.js
@modules/policy/time-window.js
@modules/policy/session-gate.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deterministic policy test suites for time-window and session-gating behavior</name>
  <files>tests/helpers/runtime-fixtures.js, tests/policy-time-window.test.js, tests/policy-session-gate.test.js, modules/policy/time-window.js, modules/policy/session-gate.js</files>
  <action>Create dedicated deterministic policy tests that target modular policy files directly (not full-route integration only). Add reusable fixtures in `tests/helpers/runtime-fixtures.js` for fixed-time and controlled Redis/session runtime inputs. Cover boundary times exactly (`00:00`, `00:59`, `01:00`, `07:59`, `08:00`) and deterministic session outcomes (`admitted:new`, `admitted:existing`, `admitted:rotated`, `blocked:slot_taken`). If needed, adjust policy module exports to accept injected `now`/clock and deterministic runtime state while preserving runtime behavior.</action>
  <verify>`node --test tests/policy-time-window.test.js tests/policy-session-gate.test.js` passes.</verify>
  <done>Policy time-window and session-gating rules are reproducible with deterministic, non-flaky automated tests.</done>
</task>

<task type="auto">
  <name>Task 2: Add explicit stream failure-branch contract coverage and align existing contract suites</name>
  <files>tests/contract-stream-failures.test.js, tests/contract-stream.test.js, tests/contract-stream-reliability.test.js</files>
  <action>Add a dedicated failure-branch contract suite for stream path regression detection: dependency timeout, dependency unavailable, invalid upstream URL/protocol, and policy-denied degraded responses. Reuse existing helpers where practical, but avoid brittle duplication by centralizing shared request/runtime fixture setup. Keep assertions focused on protocol-safe response shape and deterministic notice/fallback mapping.</action>
  <verify>`node --test tests/contract-stream.test.js tests/contract-stream-reliability.test.js tests/contract-stream-failures.test.js` passes.</verify>
  <done>Automated contract tests now lock both happy-path and failure-branch stream behavior before deployment.</done>
</task>

<task type="auto">
  <name>Task 3: Define required-vs-optional deployment test gates and add aggregate scripts</name>
  <files>package.json, TEST-GATES.md</files>
  <action>Add script-level governance in `package.json` with at least one required aggregate command (`test:gate:required`) that runs stream contract/failure suites and deterministic policy suites. Add optional aggregate command(s) for broader diagnostics suites. Document required vs optional gate tiers and command mapping in `TEST-GATES.md`, including the expectation that required gate passes before deployment.</action>
  <verify>`npm run test:gate:required` passes and `TEST-GATES.md` lists required/optional tiers with exact script names.</verify>
  <done>Maintainers have deterministic pre-deploy gate commands and written governance criteria tied to implemented test suites.</done>
</task>

</tasks>

<verification>
Run the required gate command and confirm it executes deterministic policy tests plus stream contract/failure suites with all passing.
</verification>

<success_criteria>
Maintainers can run deterministic, automated pre-deploy checks that validate stream contracts/failure branches and policy time-window/session behavior.
</success_criteria>

<output>
After completion, create `.planning/phases/05-modularization-and-test-governance/05-06-SUMMARY.md`
</output>
