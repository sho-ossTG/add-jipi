---
phase: 04-observability-and-diagnostics
plan: 02
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - observability/metrics.js
  - observability/diagnostics.js
  - serverless.js
  - tests/contract-observability.test.js
  - tests/contract-security-boundary.test.js
autonomous: true
requirements:
  - OBSV-03
must_haves:
  truths:
    - "Operators can query health and reliability metrics that summarize request failures by source without reading raw internals."
    - "Operator diagnostics endpoints remain token-gated and do not leak IPs, tokens, stack traces, or raw upstream URLs."
    - "Reliability metrics use bounded dimensions and avoid high-cardinality labels such as correlation IDs or episode IDs."
  artifacts:
    - path: observability/metrics.js
      provides: "Redis-backed reliability counters and bounded metrics aggregation helpers"
    - path: observability/diagnostics.js
      provides: "Sanitized diagnostics projection for operator health and metrics payloads"
    - path: serverless.js
      provides: "Operator diagnostics routes that return safe aggregated observability status"
    - path: tests/contract-observability.test.js
      provides: "Contract coverage for metrics shape, bounded labels, and diagnostics sanitization"
    - path: tests/contract-security-boundary.test.js
      provides: "Operator auth enforcement checks for new diagnostics routes"
  key_links:
    - from: serverless.js
      to: observability/metrics.js
      via: "request outcomes increment counters and operator route reads aggregate values"
      pattern: "stats:|increment|metrics|/operator"
    - from: serverless.js
      to: observability/diagnostics.js
      via: "health/details and operator metrics responses pass through sanitization projector"
      pattern: "health/details|operator/metrics|sanitize|project"
    - from: tests/contract-security-boundary.test.js
      to: serverless.js
      via: "unauthorized requests denied while authorized operator token returns diagnostics"
      pattern: "operator_token_required|operator_forbidden|/operator/metrics"
---

<objective>
Expose operator-safe diagnostics and key reliability metrics using bounded, sanitized telemetry projections.

Purpose: Give operators actionable production diagnostics while preserving security boundaries and avoiding sensitive-data leakage.
Output: Metrics/diagnostics modules, operator-facing telemetry endpoints, and contract tests for auth + redaction safety.
</objective>

<execution_context>
@C:/Users/enggy/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/enggy/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-observability-and-diagnostics/04-RESEARCH.md
@.planning/phases/04-observability-and-diagnostics/04-01-SUMMARY.md
@serverless.js
@tests/contract-security-boundary.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Redis-backed reliability metrics with bounded dimensions</name>
  <files>observability/metrics.js, serverless.js</files>
  <action>Create `observability/metrics.js` helpers for recording and reading reliability counters in Redis keyed by bounded dimensions only (for example `source`, `cause`, `routeClass`, `result`), explicitly excluding high-cardinality values such as correlation ID, raw IP, episode ID, or full user agent. Wire server request outcomes in `serverless.js` to increment these counters for success/degraded/failure paths so metrics remain cross-instance and deterministic.</action>
  <verify>Run `npm run test:contract:observability` and confirm metrics assertions pass for bounded-key updates.</verify>
  <done>Reliability counters are persisted in Redis with bounded labels and reflect request outcomes by source/cause class.</done>
</task>

<task type="auto">
  <name>Task 2: Add sanitized operator diagnostics projections and routes</name>
  <files>observability/diagnostics.js, serverless.js</files>
  <action>Create `observability/diagnostics.js` projection helpers that transform internal telemetry into allowlisted operator payloads only. Extend operator routes in `serverless.js` (for example `/health/details` and `/operator/metrics`) to return status plus key reliability metrics from `observability/metrics.js`, while stripping stack traces, tokens, raw IPs, and raw upstream endpoint values. Keep public routes minimal and unchanged; diagnostics remain operator-only under existing token gate.</action>
  <verify>Run `npm run test:contract:security` and `npm run test:contract:observability`.</verify>
  <done>Operators can query health + reliability metrics through token-gated routes with sanitized payloads and no sensitive internals leakage.</done>
</task>

<task type="auto">
  <name>Task 3: Lock observability operator contracts for auth, redaction, and metric shape</name>
  <files>tests/contract-observability.test.js, tests/contract-security-boundary.test.js</files>
  <action>Expand observability contract tests to validate operator diagnostics response shape, bounded metric label set, and absence of sensitive fields (`authorization`, `x-forwarded-for`, raw IP, stack, broker URL). Update security-boundary contract tests so unauthorized requests to new operator metrics endpoints return deny responses, and authorized requests succeed with sanitized telemetry payloads.</action>
  <verify>Run `npm run test:contract:observability && npm run test:contract:security && npm run test:contract:reliability`.</verify>
  <done>Auth gating, redaction safety, and operator metric contract shape are enforced by executable tests.</done>
</task>

</tasks>

<verification>
Run `npm run test:contract:observability && npm run test:contract:security && npm run test:contract:reliability && npm run test:contract:stream && npm run test:contract:cors && npm run test:contract:manifest-catalog`.
</verification>

<success_criteria>
1. `/health/details` and operator metrics expose key reliability telemetry without sensitive internals.
2. Unauthorized operator diagnostics requests are denied and authorized requests return sanitized structured data.
3. Reliability metrics are queryable by bounded source/cause classes across instances.
</success_criteria>

<output>
After completion, create `.planning/phases/04-observability-and-diagnostics/04-02-SUMMARY.md`
</output>
