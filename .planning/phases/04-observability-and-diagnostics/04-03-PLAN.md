---
phase: 04-observability-and-diagnostics
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - serverless.js
  - observability/diagnostics.js
  - tests/contract-observability.test.js
autonomous: true
gap_closure: true
requirements:
  - OBSV-03
must_haves:
  truths:
    - "Operator health and metrics diagnostics are both projected through shared sanitization helpers."
    - "`/health/details` payload shape stays intentionally aligned with the shared health projector output."
    - "Contract tests fail if `/health/details` bypasses projector wiring or leaks unsanitized fields."
  artifacts:
    - path: serverless.js
      provides: "`/health/details` route wiring that calls shared health diagnostics projector for success and failure responses"
    - path: observability/diagnostics.js
      provides: "Canonical `projectOperatorHealth` projection used by handler responses"
    - path: tests/contract-observability.test.js
      provides: "Contract assertions that lock `/health/details` projector-aligned response shape and sanitization"
  key_links:
    - from: serverless.js
      to: observability/diagnostics.js
      via: "`/health/details` success and error branches both call `projectOperatorHealth(...)` before response send"
      pattern: "health/details|projectOperatorHealth"
    - from: tests/contract-observability.test.js
      to: serverless.js
      via: "handler-level assertions validate `/health/details` contract uses projector-shaped diagnostics"
      pattern: "/health/details|reliability|status"
---

<objective>
Close the remaining Phase 4 diagnostics projection gap so all operator diagnostics routes use shared sanitization helpers.

Purpose: Eliminate projection drift between `/operator/metrics` and `/health/details` so operators get consistent, safe diagnostics contracts.
Output: Unified `/health/details` projection wiring and contract tests that lock projector-aligned payload behavior.
</objective>

<execution_context>
@C:/Users/enggy/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/enggy/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-observability-and-diagnostics/04-RESEARCH.md
@.planning/phases/04-observability-and-diagnostics/04-02-SUMMARY.md
@.planning/phases/04-observability-and-diagnostics/04-observability-and-diagnostics-VERIFICATION.md
@observability/diagnostics.js
@serverless.js
@tests/contract-observability.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Route `/health/details` through shared health diagnostics projector</name>
  <files>serverless.js, observability/diagnostics.js</files>
  <action>Update `/health/details` handling in `serverless.js` so both success and failure/degraded branches build responses via `projectOperatorHealth(...)` (or an equivalent single shared helper from `observability/diagnostics.js`) instead of inline JSON literals. Keep route auth behavior unchanged, keep payload intentionally allowlisted, and avoid duplicating projection logic in the route handler.</action>
  <verify>Run `npm run test:contract:observability` and confirm `/health/details` contract checks pass with projector-based wiring.</verify>
  <done>`/health/details` no longer returns inline diagnostics payloads; it consistently responds with shared projector output in all branches.</done>
</task>

<task type="auto">
  <name>Task 2: Lock `/health/details` projector contract and sanitization expectations</name>
  <files>tests/contract-observability.test.js</files>
  <action>Add or update contract tests to assert that `/health/details` response shape matches projector output conventions and excludes sensitive/internal fields (for example raw stack traces, authorization token data, forwarded IP headers, raw upstream URLs). Include at least one non-OK branch assertion so bypass regressions are caught even when dependency checks fail.</action>
  <verify>Run `npm run test:contract:observability && npm run test:contract:security`.</verify>
  <done>Contract suite explicitly protects shared projector usage for `/health/details` and fails on future shape/sanitization drift.</done>
</task>

</tasks>

<verification>
Run `npm run test:contract:observability && npm run test:contract:security && npm run test:contract:reliability`.
</verification>

<success_criteria>
1. `/health/details` and `/operator/metrics` both use shared diagnostics projection helpers from `observability/diagnostics.js`.
2. `/health/details` success and degraded/failure outputs remain sanitized and projector-shaped with no inline payload drift.
3. Contract tests detect any future bypass of shared projector wiring for operator health diagnostics.
</success_criteria>

<output>
After completion, create `.planning/phases/04-observability-and-diagnostics/04-03-SUMMARY.md`
</output>
